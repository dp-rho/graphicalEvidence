
#########################################################################
# Temporary file only used for generating input parameters, not expected
# to be included in final package
#########################################################################

package_dir <- system.file(package = "graphicalEvidence")

# Read in pre existing matrices generated by MATLAB code
gen_params_G_Wishart <- function() {
  g_mat <- read.csv(file.path(
    package_dir, 'test_params', 'G_mat_q_50_n_100_delta_15.csv'
  ), header=FALSE)
  scale_mat <- read.csv(file.path(
    package_dir, 'test_params', 'Scale_mat_q_50_n_100_delta_15.csv'
  ), header=FALSE)
  S_mat <- read.csv(file.path(
    package_dir, 'test_params', 'S_mat_q_50_n_100_delta_15.csv'
  ), header=FALSE)
  X_mat <- read.csv(file.path(
    package_dir, 'test_params', 'X_mat_q_50_n_100_delta_15.csv'
  ), header=FALSE)
  start_gibbs <- read.csv(file.path(
    package_dir, 'test_params', 'start_gibbs_q_50_n_100_delta_15.csv'
  ), header=FALSE)
  
  return(list(
    X_mat=X_mat, g_mat=g_mat, S_mat=S_mat, scale_mat=scale_mat, 
    start_gibbs=start_gibbs
  ))
}

# Global env for tracking time usage of subsections of code
g_time_env <- new.env(parent=.GlobalEnv)

test_G_Wishart <- function() {
  
  # Get predetermined test inputs generated in MATLAB
  params <- gen_params_G_Wishart()
  
  print("Params are: ")
  print(params)
  
  # Make results repeatable
  rs_seed <- 12345678
  set.seed(rs_seed)
  set_seed(rs_seed)
  
  # Sample size
  num_runs <- 2
  
  # Init store for estimated marginal repeated runs
  estimated_marginal_store <- numeric(num_runs)
  
  # Initialize compiled timers
  reset_times()
  
  # Save start in R program time
  our_time <- proc.time()
  
  # Subsection time profiling 
  g_time_env$vec_log_normal_calc_time <- 0
  g_time_env$mcmc_hw_calc_time <- 0
  
  # Call top level function
  for (i in 1:num_runs) {
    estimated_marginal_store[i] <- evidence(
      xx=params$X_mat, S=params$S_mat, n=100, p=50, burnin=2e3, nmc=1e4,
      prior_name='G_Wishart', alpha=15, V=params$scale_mat, G=params$g_mat,
      start_gibbs=params$start_gibbs
    )
  }
  
  # Cumulative execution time in R program
  cat('Execution time in R program (seconds):\n')
  print((proc.time() - our_time) / num_runs)
  
  # R program execution time for Hao Wang MCMC sampling (unrestricted)
  cat("Time spend in unrestricted Hao Wang MCMC in R program (seconds)\n")
  print(g_time_env$mcmc_hw_calc_time / num_runs)
  
  # R program execution time for vec_log_normal_density
  cat("Time spend calculating vec_log_normal_density in R program (seconds)\n")
  print(g_time_env$vec_log_normal_calc_time / num_runs)
  
  # Compiled code time
  print_times(num_runs)
  
  # Estimated mean (sd)
  cat(paste0("ans = ", mean(estimated_marginal_store), " (", 
             sqrt(var(estimated_marginal_store)), ")"))

}
